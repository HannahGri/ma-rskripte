

# Erstellung einer symmetrischen und positiv definiten Korrelationsmatrix mit 'polycor' auf Basis eines Teil-Datensatzes. 
# Die Matrix der Rohwerte wird zur Simulation der Korrelationen verwendet.

corr_matr <- structure(c(1, 0.0226904386241001, 0.287423910191864, 0.039297466879287, 0.0834945283290452, 0.237943818619894, 0.240336583363007, 0.155652537737046, 0.508272659484203,
                         0.0445385334107076, 0.104312624921644, -0.176013556143049, -0.0753122660398333, -0.117385197212055, -0.593922021361118, 0.0256042094561309, 0.143409639622577, 
                         0.166281362437914, 0.191474523468914, 0.261790709692442, 0.00458902294453562, -0.0104526596086264, -0.0341515382332764, 0.0160200065702116, 0.0226904386241001, 
                         1, 0.281230467559081, -0.0200928245746959, 0.0890834976575749, 0.0885450645175781, 0.0547763637051538, -0.0507595010487025, 0.0401432409755137, -0.0381435728993085,
                         0.187192576902336, 0.0404566057141824, -0.103681529569573, -0.040429965832838, -0.00437896683197318, -0.0373298860547858, 0.0248212528859221, 0.0786234614814761, 
                         0.0369437722110703, 0.0778558224574771, -0.00617669333742416, 0.0343738134746495, 0.0121400164785561, 0.0135586867428188, 0.287423910191864, 0.281230467559081, 1,
                         -0.0130282168344179, 0.109706295978816, 0.0774223428421797, 0.0638038806010484, 0.0809481661786407, 0.110370708563354, -0.0283595409810171, 0.270383025511398,
                         0.0395780811439311, -0.0319871164139846, -0.0652150327833336, -0.184209846008033, -0.0360899884158953, 0.112290971631208, 0.0647034298650168, 0.0630669709153504,
                         0.121719134154514, -0.000281503022599561, -0.00127778474183839, -0.0117029408683092, 0.0139628205916413, 0.039297466879287, -0.0200928245746959, -0.0130282168344179, 
                         1, 0.011358025125039, 0.220593991953974, 0.0342112603677627, 0.21650219689543, 0.0363976735636515, -0.0467066587814247, -0.0101361383254415, -0.0997089641051666, 
                         -0.0465303144315876, -0.0653677890044049, -0.011299216083668, 0.49037873655004, 0.0784821512646559, 0.158395160452917, 0.0550878981047605, 0.0284346996737608,
                         0.0201058167775078, 0.0882982129826988, 0.00936816800414712, 0.000624917748361539, 0.0834945283290452, 0.0890834976575749, 0.109706295978816, 0.011358025125039, 1, 
                         -0.0653937926260895, 0.067300633994607, 0.0610547962409984, 0.0948268613822006, 0.0367312136457556, 0.465725386956986, 0.170047114414291, 0.0440070053640328, 
                         -0.0939974597921537, -0.041559966191614, -0.112395499849137, 0.0823261502880136, 0.0282832426842873, 0.0486696283187448, 0.0802734830861672, 0.00207531837965094,
                          0.00237210081778481, 0.00417943130481191, 0.0031161796613389, 0.237943818619894, 0.0885450645175781, 0.0774223428421797, 0.220593991953974, -0.0653937926260895, 1,
                         0.357775399159064, -0.136664360969408, 0.101612791888658, -0.140469197417607, 0.0356076816533852, -0.083361771371511, -0.182012595573331, -0.0182408764137174, 
                         -0.136100945418238, -0.387529967607916, 0.136788041502741, 0.325056160222388, 0.128049193183271, 0.138561215374614, -0.00111949149376937, 0.000825545902129592, 
                         -0.00283294669440345, -0.00129965121479351, 0.240336583363007, 0.0547763637051538, 0.0638038806010484, 0.0342112603677627, 0.067300633994607, 0.357775399159064, 1, 
                          0.0820408521621895, 0.452819998516235, -0.333822125782146, -0.0776718343244727, -0.278382362019213, -0.263123662238071, -0.263992589645078, -0.132641622128831,
                         -0.034347791663436, -0.0282248126303432, -0.101080773227392, -0.104828468010756, 0.0559786412806355, 0.000342936517829991, 0.000182985706867545, 0.000748056534881215,
                          0.000477077973460438, 0.155652537737046, -0.0507595010487025, 0.0809481661786407, 0.21650219689543, 0.0610547962409984, -0.136664360969408, 0.0820408521621895, 1,
                          0.185827963015735, 0.0933948959137593, -0.0903079549923995, -0.166126860419304, 0.0330735740458135, -0.169501271365861, -0.0876700403517159, 0.0105520759242259,
                         -0.0401522330491124, -0.129739969426336, -0.0541225759870832, -0.0615281989438208, 0.00107133594387495, -0.0684571949035689, -0.0216930841373259, -0.000515359520740467, 
                         0.508272659484203, 0.0401432409755137, 0.110370708563354, 0.0363976735636515, 0.0948268613822006, 0.101612791888658, 0.452819998516235, 0.185827963015735, 1,
                         0.34840263857102, -0.0744526566427002, -0.31451072903262, -0.160179611580385, -0.236244113206871, -0.251742664639493, 0.149600957446054, -0.0511551891742671,
                         -0.177244701333524, -0.163711139349596, 0.0751243910327169, -0.000157014509342362, -0.0308564984124284,  -0.017522780533263, 0.0272134325552771, 0.0445385334107076,
                         -0.0381435728993085, -0.0283595409810171, -0.0467066587814247, 0.0367312136457556, -0.140469197417607, -0.333822125782146, 0.0933948959137593, 0.34840263857102, 
                       1, 0.120678332117263, 0.0870872437839783, 0.0609484110939613, -0.00822271637149716, -0.0141406824247951, 0.0897568275641666, -0.0289528929242576, -0.0618700422548778,
                         -0.0674522928819803, -0.0100005262490001, -0.0171701830772989, -0.0398447390584043, -0.00026882529046429, 0.00177021861145405, 0.104312624921644, 0.187192576902336,
                         0.270383025511398, -0.0101361383254415, 0.465725386956986, 0.0356076816533852, -0.0776718343244727, -0.0903079549923995, -0.0744526566427002, 0.120678332117263, 1,
                         0.226475856886428, -0.498404077271821, -0.426134331251291, -0.024655632375222, -0.0571399116281469, 0.404852084380097, 0.72261011130612, 0.309474537039162, 0.39651845633678, 
                       -0.0189961999266772, 0.153760483764491, 0.131395408383706, 0.0476131949162835, -0.176013556143049, 0.0404566057141824, 0.0395780811439311, -0.0997089641051666, 
                       0.170047114414291, -0.083361771371511, -0.278382362019213, -0.166126860419304, -0.31451072903262, 0.0870872437839783, 0.226475856886428, 1, 0.378192983783549, 
                         0.512239936388876, 0.102098292952381, 0.010492510706393, -0.585427995545704, 0.130676035812429, -0.147850827548203, 0.0463390446040934, -0.102446205388025, 
                         -0.00929447972426656, -0.03083177249573, -0.0108387328957429, -0.0753122660398333, -0.103681529569573, -0.0319871164139846, -0.0465303144315876, 0.0440070053640328, 
                       -0.182012595573331, -0.263123662238071, 0.0330735740458135, -0.160179611580385, 0.0609484110939613, -0.498404077271821, 0.378192983783549, 1, 0.853385976641362, 
                         0.0637205205851635, 0.0351892903290928, -0.260490321862042, -0.552501450152432, -0.244163605123395, -0.158502833667146, -0.0264423054042917, -0.235774474607536, 
                         -0.0842530835684559, -0.0312434737328059, -0.117385197212055, -0.040429965832838, -0.0652150327833336, -0.0653677890044049, -0.0939974597921537, -0.0182408764137174, 
                       -0.263992589645078, -0.169501271365861, -0.236244113206871, -0.00822271637149716, -0.426134331251291, 0.512239936388876, 0.853385976641362, 1, 0.0659875345870315,
                         -0.0268318878454995, -0.292989462032138, -0.271947083658842, -0.466963961901093, -0.136461190281954, -0.0249697687575234, -0.0974050459586575, -0.210424238611321,
                         -0.0334338432090506, -0.593922021361118, -0.00437896683197318, -0.184209846008033, -0.011299216083668, -0.041559966191614, -0.136100945418238, -0.132641622128831, 
                       -0.0876700403517159, -0.251742664639493, -0.0141406824247951, -0.024655632375222, 0.102098292952381, 0.0637205205851635, 0.0659875345870315, 1, -0.0281278386968229, 
                         -0.0496749887838582, -0.0574028669144437, -0.0539591844173198, -0.219058234918179, -0.00503013775320571, 0.00886899157476157, 0.0306543119596255, -0.0431019382986771, 
                       0.0256042094561309, -0.0373298860547858, -0.0360899884158953, 0.49037873655004, -0.112395499849137, -0.387529967607916, -0.034347791663436, 0.0105520759242259, 
                         0.149600957446054, 0.0897568275641666, -0.0571399116281469, 0.010492510706393, 0.0351892903290928, -0.0268318878454995, -0.0281278386968229, 1, -0.062839913360847,
                         -0.162917251586024, -0.05803402062865, -0.0494605641000931, -0.030124490607338, -0.0672412007176045, -0.014782984303607, -0.0121701191207863, 0.143409639622577, 0.0248212528859221, 
                       0.112290971631208, 0.0784821512646559, 0.0823261502880136, 0.136788041502741, -0.0282248126303432, -0.0401522330491124, -0.0511551891742671, -0.0289528929242576, 0.404852084380097,
                         -0.585427995545704, -0.260490321862042, -0.292989462032138, -0.0496749887838582, -0.062839913360847, 1, 0.37104301439051, 0.248863116222105, 0.139431099848222, 0.0447702844078559, 
                       0.0709595951257, 0.0575570523889661, 0.0170151781425866, 0.166281362437914,  0.0786234614814761, 0.0647034298650168, 0.158395160452917, 0.0282832426842873, 0.325056160222388,
                         -0.101080773227392, -0.129739969426336, -0.177244701333524, -0.0618700422548778, 0.72261011130612, 0.130676035812429, -0.552501450152432, -0.271947083658842, -0.0574028669144437,
                         -0.162917251586024, 0.37104301439051, 1, 0.328832194760975, 0.218727471490621, 0.0379215581980224, 0.163572499797686, 0.0384408440224415, 0.0178186364573276, 0.191474523468914, 
                       0.0369437722110703, 0.0630669709153504, 0.0550878981047605, 0.0486696283187448, 0.128049193183271, -0.104828468010756, -0.0541225759870832, -0.163711139349596, 
                       -0.0674522928819803, 0.309474537039162, -0.147850827548203, -0.244163605123395, -0.466963961901093, -0.0539591844173198, -0.05803402062865, 0.248863116222105, 
                       0.328832194760975, 1, 0.195346272885473, 0.0244740959101868,  0.0639107913260762, 0.0698693385542489, -0.0051590865782654, 0.261790709692442, 0.0778558224574771,
                         0.121719134154514, 0.0284346996737608, 0.0802734830861672, 0.138561215374614, 0.0559786412806355, -0.0615281989438208, 0.0751243910327169, -0.0100005262490001, 
                         0.39651845633678, 0.0463390446040934, -0.158502833667146, -0.136461190281954, -0.219058234918179, -0.0494605641000931, 0.139431099848222, 0.218727471490621, 0.195346272885473, 
                         1, -0.00502847774179793, 0.000581964890318018, 0.00591544000093016, 0.0357049946876831, 0.00458902294453562, -0.00617669333742416, -0.000281503022599561, 0.0201058167775078, 
                         0.00207531837965094, -0.00111949149376937, 0.000342936517829991, 0.00107133594387495, -0.000157014509342362, -0.0171701830772989, -0.0189961999266772, -0.102446205388025, 
                       -0.0264423054042917, -0.0249697687575234, -0.00503013775320571, -0.030124490607338, 0.0447702844078559, 0.0379215581980224, 0.0244740959101868, -0.00502847774179793, 1, 
                         0.0309038347665612, 0.00893184356049356, 0.00555241685789343, -0.0104526596086264, 0.0343738134746495, -0.00127778474183839, 0.0882982129826988, 0.00237210081778481, 
                       0.000825545902129592, 0.000182985706867545, -0.0684571949035689, -0.0308564984124284, -0.0398447390584043, 0.153760483764491, -0.00929447972426656, -0.235774474607536,
                         -0.0974050459586575, 0.00886899157476157, -0.0672412007176045, 0.0709595951257, 0.163572499797686, 0.0639107913260762, 0.000581964890318018, 0.0309038347665612, 
                       1, 0.0319926090070085, 0.0108283404244461, -0.0341515382332764, 0.0121400164785561, -0.0117029408683092, 0.00936816800414712, 0.00417943130481191, -0.00283294669440345,
                         0.000748056534881215, -0.0216930841373259, -0.017522780533263, -0.00026882529046429, 0.131395408383706, -0.03083177249573, -0.0842530835684559, -0.210424238611321, 
                       0.0306543119596255, -0.014782984303607, 0.0575570523889661, 0.0384408440224415, 0.0698693385542489, 0.00591544000093016, 0.00893184356049356, 0.0319926090070085, 1,
                         0.00311955305521792, 0.0160200065702116, 0.0135586867428188, 0.0139628205916413, 0.000624917748361539, 0.0031161796613389, -0.00129965121479351, 0.000477077973460438, 
                       -0.000515359520740467, 0.0272134325552771, 0.00177021861145405, 0.0476131949162835, -0.0108387328957429, -0.0312434737328059, -0.0334338432090506, -0.0431019382986771,
                         -0.0121701191207863, 0.0170151781425866, 0.0178186364573276, -0.0051590865782654, 0.0357049946876831, 0.00555241685789343, 0.0108283404244461, 0.00311955305521792, 1),
                       dim = c(24, 24), 
                       dimnames = list(c("Jahr", "HGK", "SGK", "Betr", "Alter_kat", "VS_kat", "qm_kat", "BAKL", 
                                         "AVB", "UVVZ", "Rohbau", "Feu", "LW", "ST", "EL", "gew", "Vorschaden_feuer", 
                                         "Vorschaden_lw", "Vorschaden_sturm", "Vorschaden_el", 
                                         "y_feuer", "y_lw", "y_sturm", "y_el"), 
                                       c("Jahr", "HGK", "SGK", "Betr", "Alter_kat", "VS_kat", "qm_kat", "BAKL", 
                                         "AVB", "UVVZ", "Rohbau", "Feu", "LW", "ST", "EL", "gew", "Vorschaden_feuer",
                                         "Vorschaden_lw", "Vorschaden_sturm", "Vorschaden_el", 
                                         "y_feuer", "y_lw", "y_sturm", "y_el")))



set.seed(123)
n <- 50000 # Anzahl zu simulierender Datenpunkte  

# Generierung multivariat normalverteilter Rohdaten mit Korrelation mithilfe des R-Pakets 'Mass'.
# Die Erwartungswerte der Aufwandshöhen wurden näherungsweise mittels Maximum-Likelihood aus den Originaldaten geschätzt.
mv_data <- MASS::mvrnorm(n, mu = c(rep(0, 20),
                                   3.1, #Feuerschäden
                                   3.2, #Leitungswasserschäden
                                   2.9, #Sturmschäden
                                   3.7 #Elementarschäden
                                  ), 
                         Sigma = corr_matr)

# Diskretisierung der Kovariablen mit vorgegebener Wahrscheinlichkeitsverteilung, die den Originaldaten ähneln
sim_data_draft <- mv_data %>% as.data.frame %>% mutate(
  Jahr = cut(mv_data[,1], breaks = c(-Inf, qnorm(cumsum(seq(0.07, 0.16, length.out=10)/sum(seq(0.07, 0.16, length.out=10))))), labels = 2014:2023),
  HGK = cut(mv_data[,2], breaks = c(-Inf, qnorm(cumsum(c(0.04, 0.87, 0.07, 0.01, 0.01)))), labels = 0:4),
  SGK = cut(mv_data[,3], breaks = c(-Inf, qnorm(cumsum(c(0.31, 0.16, 0.46, 0.07)))), labels = 0:3),
  Betr = cut(mv_data[,4], breaks = c(-Inf, qnorm(cumsum(c(0.002, 0.03, 0.03, 0.8, 0.128, 0.01)))), labels = c("00000", "00051", "00052", "00053", "00055", "00059")),
  Alter_kat = cut(mv_data[,5], breaks = c(-Inf, qnorm(cumsum(dnorm(0:61, mean = 0, sd=15) / sum(dnorm(0:61, mean = 0, sd=15))))), labels = 0:61),
  VS_kat = cut(mv_data[,6], breaks =  c(-Inf, qnorm(cumsum(dnorm(0:57, mean = 23, sd = 7)/ sum(dnorm(0:57, mean = 23, sd = 7))))) , labels = 0:57),
  qm_kat = cut(mv_data[,7], breaks =  c(-Inf, qnorm(cumsum( c(0.45, 0.55* dnorm(1:50, mean = 6, sd = 5.5)/sum(dnorm(1:50, mean = 6, sd = 5.5)))))), labels = 0:50),
  BAKL = cut(mv_data[,8], breaks = c(-Inf, qnorm(cumsum(c(0.01, 0.95, 0.03, 0.01)))), labels = 0:3),
  AVB = cut(mv_data[,9], breaks = c(-Inf, qnorm(cumsum(c(0.0002, 0.004, 0.0008, 0.005, 0.24, 0.3, 0.16, 0.03, 0.26)))), labels = c("00", "01", "02", "03", "06", "12", "14", "15", "98")),
  UVVZ = cut(mv_data[,10], breaks = c(-Inf, qnorm(cumsum(c(0.3, 0.7)))), labels = 1:2),
  Rohbau = cut(mv_data[,11], breaks = c(-Inf, qnorm(cumsum(c(0.003, 0.997)))), labels = 1:2),
  LW = cut(mv_data[,12], breaks = c(-Inf, qnorm(cumsum(c(0.95, 0.05)))), labels = 1:2),
  Feu = cut(mv_data[,13], breaks = c(-Inf, qnorm(cumsum(c(0.96, 0.04)))), labels = 1:2),
  ST = cut(mv_data[,14], breaks = c(-Inf, qnorm(cumsum(c(0.97, 0.03)))), labels = 1:2),
  EL = cut(mv_data[,15], breaks = c(-Inf, qnorm(cumsum(c(0.24, 0.51, 0.248, 0.002)))), labels = c(1, 2, 3, 5)),
  gew = cut(mv_data[,16], breaks = c(-Inf, qnorm(cumsum(c(0.02, 0.001, 0.979)))), labels = c(1, 2, 9)),
  Vorschaden_lw = cut(mv_data[,17], breaks = c(-Inf, qnorm(cumsum(c(0.9, 0.1)))), labels = 0:1),
  Vorschaden_feuer = cut(mv_data[,18], breaks = c(-Inf, qnorm(cumsum(c(0.98, 0.02)))), labels = 0:1),
  Vorschaden_sturm = cut(mv_data[,19], breaks = c(-Inf, qnorm(cumsum(c(0.9, 0.1)))), labels = 0:1),
  Vorschaden_el = cut(mv_data[,20], breaks = c(-Inf, qnorm(cumsum(c(0.99, 0.01)))), labels = 0:1)
)

# Beispielhafte Darstellung der Verteilungen der Kovaribalen
ggplot(data=sim_data_draft)+
  geom_bar(aes(x=Jahr))

ggplot(data=sim_data_draft)+
  geom_bar(aes(x=VS_kat))

ggplot(data=sim_data_draft)+
  geom_bar(aes(x=Betr))

# Logistische Regression für 0-Wahrscheinlichkeiten der Aufwandshöhen zur Umwandlung in die Mischverteilung (Dirac(0)-Normalverteilung)
# Die Koeffizienten resultieren aus logistischer Regression der Rohdaten (hier beispielhaft abhängig von Jahr und Versicherungssumme)

eta_lw <- -118.19 +  0.06224*as.numeric(as.character(sim_data_draft[,"Jahr"])) - 0.15818*as.numeric(as.character(sim_data_draft[,"VS_kat"]))
p0_lw <- 1 / (1 + exp(-eta_lw))

eta_sturm <- -80.073 +  0.04368*as.numeric(as.character(sim_data_draft[,"Jahr"])) - 0.11473*as.numeric(as.character(sim_data_draft[,"VS_kat"]))
p0_sturm <- 1 / (1 + exp(-eta_sturm))

eta_feuer <- -135.23 +  0.06921*as.numeric(as.character(sim_data_draft[,"Jahr"])) - 0.04483*as.numeric(as.character(sim_data_draft[,"VS_kat"]))
p0_feuer <- 1 / (1 + exp(-eta_feuer))

eta_el <- 261.66 - 0.12596*as.numeric(as.character(sim_data_draft[,"Jahr"])) - 0.04871*as.numeric(as.character(sim_data_draft[,"VS_kat"]))
p0_el <- 1 / (1 + exp(-eta_el))

set.seed(102)
y_zero_lw <- rbinom(n, size = 1, prob = p0_lw)
y_zero_sturm <- rbinom(n, size = 1, prob = p0_sturm)
y_zero_feuer <- rbinom(n, size = 1, prob = p0_feuer)
y_zero_el <- rbinom(n, size = 1, prob = p0_el)

sim_data_draft <- sim_data_draft %>% mutate(y_lw=ifelse(y_zero_lw == 1, 0, mv_data[, "y_lw"]),
                               y_sturm=ifelse(y_zero_sturm == 1, 0, mv_data[, "y_sturm"]),
                               y_feuer=ifelse(y_zero_feuer == 1, 0, mv_data[, "y_feuer"]),
                               y_el=ifelse(y_zero_el == 1, 0, mv_data[, "y_el"]))



data_sim <- tibble(sim_data_draft) %>% mutate(
  across(-c(y_feuer, y_lw, y_sturm, y_el,
            VS_kat,Alter_kat, qm_kat, Jahr), as.factor),
  across(c(y_feuer, y_lw, y_sturm, y_el,
           VS_kat,Alter_kat, qm_kat, Jahr), as.numeric)) %>%
  mutate(Nr = (1:n))  # Nummer zuordnen, damit jeder Datensatz als eindeutig aufgefasst wird


# Aufteilung in Test- und Trainingsdaten (20 - 80) 
set.seed(80)

test_data<- data_sim%>%
  group_by(Jahr,qm_kat, VS_kat ) %>%
  sample_frac(0.2) %>%
  ungroup()

test_features<- test_data%>% select(-c(y_feuer,
                                       y_lw,
                                       y_sturm, y_el,
                                       Nr))

test_Y<- test_data%>% select(y_feuer, y_lw, y_sturm, y_el) 

train_data<- data_sim%>% anti_join(test_data) 

train_features<- train_data%>% select(-c(y_feuer,
                                         y_lw,
                                         y_sturm, y_el,
                                         Nr))
train_Y<- train_data%>% select(y_feuer, y_lw, y_sturm, y_el) 
